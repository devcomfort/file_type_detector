name: Update Lock Files After Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number to update lock files for (e.g., 0.1.1)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      new-version: ${{ steps.check.outputs.version }}
      old-version: ${{ steps.check.outputs.old_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "old_version=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')" >> $GITHUB_OUTPUT
          else
            # Check if pyproject.toml was modified in the last commit
            if git diff HEAD~1 HEAD --name-only | grep -q "^pyproject.toml$"; then
              OLD_VERSION=$(git show HEAD~1:pyproject.toml | grep -E '^version\s*=' | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              NEW_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              
              if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
                echo "Version changed: $OLD_VERSION -> $NEW_VERSION"
              else
                echo "changed=false" >> $GITHUB_OUTPUT
                echo "Version did not change"
              fi
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "pyproject.toml was not modified"
            fi
          fi

  update-lock-files:
    needs: check-version-change
    if: needs.check-version-change.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install rye
        uses: rye/setup-rye@v1
        with:
          enable-cache: true

      - name: Sync dependencies
        run: |
          rye sync
          rye lock --check || rye lock

      - name: Check for changes
        id: changes
        run: |
          git add -N requirements.lock requirements-dev.lock
          if git diff --exit-code requirements.lock requirements-dev.lock; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in lock files"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Lock files have changes"
          fi

      - name: Get lock file diff
        id: diff
        if: steps.changes.outputs.changed == 'true'
        run: |
          git diff requirements.lock requirements-dev.lock > lock_diff.txt || true
          DIFF_CONTENT=$(cat lock_diff.txt | head -c 65000 || echo "Diff too large to display")
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed packages
        id: packages
        if: steps.changes.outputs.changed == 'true'
        run: |
          # Extract package names from diff
          CHANGED=$(git diff requirements.lock requirements-dev.lock | grep -E '^\+.*==|^\-.*==' | grep -v '^+++' | grep -v '^---' | sort -u | head -30 || echo "Various packages updated")
          echo "packages<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create branch and commit
        if: steps.changes.outputs.changed == 'true'
        run: |
          VERSION="${{ needs.check-version-change.outputs.new-version }}"
          BRANCH_NAME="chore/update-lock-files-v${VERSION}"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git checkout -b "$BRANCH_NAME"
          git add requirements.lock requirements-dev.lock
          git commit -m "chore: Update lock files for version $VERSION

          Auto-generated commit to update dependency lock files after version bump.

          Version: ${{ needs.check-version-change.outputs.old-version }} -> $VERSION"
          
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/update-lock-files-v${{ needs.check-version-change.outputs.new-version }}
          title: "chore: Update lock files for version ${{ needs.check-version-change.outputs.new-version }}"
          body: |
            ## ğŸ”„ Lock Files Update

            This PR automatically updates the dependency lock files after the version bump to **${{ needs.check-version-change.outputs.new-version }}**.

            ### ğŸ“‹ Summary

            - **Previous version**: `${{ needs.check-version-change.outputs.old-version }}`
            - **New version**: `${{ needs.check-version-change.outputs.new-version }}`
            - **Files updated**: `requirements.lock`, `requirements-dev.lock`

            ### ğŸ“Š Changed Packages

            <details>
            <summary>Click to expand package changes</summary>

            ```
            ${{ steps.packages.outputs.packages }}
            ```

            </details>

            ### ğŸ“ Lock File Differences

            <details>
            <summary>Click to expand full diff</summary>

            ```diff
            ${{ steps.diff.outputs.diff }}
            ```

            </details>

            ### âœ… Checklist

            - [x] Lock files updated using `rye sync` and `rye lock`
            - [ ] Review dependency changes
            - [ ] Verify no security vulnerabilities introduced
            - [ ] Confirm tests pass with new dependencies

            ### ğŸ¤– Auto-generated

            This PR was automatically created by the GitHub Actions workflow `update-lock-files.yml`.

            **Trigger**: Version change in `pyproject.toml` from `${{ needs.check-version-change.outputs.old-version }}` to `${{ needs.check-version-change.outputs.new-version }}`

            ---
            *Please review the dependency changes carefully before merging.*
          labels: |
            dependencies
            automated
            chore
          draft: false
